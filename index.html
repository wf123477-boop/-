<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æˆåŠŸæ—¥è¨˜ Success Journal</title>
  <style>
    * { box-sizing: border-box; font-family: "Noto Sans TC", sans-serif; }

    body { margin: 0; padding: 0; background: #f3f6f9; color: #333; }

    header {
      background-color: #4a90e2; color: white; text-align: center; padding: 1rem;
    }

    .instructions {
      max-width: 700px; margin: 0.5rem auto; text-align: left;
      background: rgba(255,255,255,0.1); padding: 0.5rem 1rem;
      border-radius: 5px;
    }
    .instructions summary {
      cursor: pointer; font-weight: bold; list-style: none;
    }
    .instructions summary::-webkit-details-marker { display: none; }
    .instructions div { margin-top: 0.5rem; line-height: 1.6; }

    main {
      display: flex; flex-direction: column; align-items: center; padding: 1rem;
    }

    .calendar {
      background: white; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 1rem; width: 100%; max-width: 700px;
    }

    .month-selector {
      display: flex; justify-content: space-between; align-items: center;
      width: 100%; max-width: 400px; margin: 0 auto 10px auto;
    }

    .month-selector button {
      background-color: #4a90e2; color: white; border: none;
      border-radius: 5px; padding: 0.4rem 1rem; cursor: pointer;
    }

    .month-selector button:hover { background-color: #357abd; }

    .month-selector span { font-weight: bold; font-size: 1.2rem; }

    table { border-collapse: collapse; width: 100%; }
    th, td { text-align: center; padding: 5px; width: 14.28%; }
    th { background-color: #e1ebf7; }
    td {
      border: 1px solid #ddd; height: 80px; vertical-align: top; cursor: pointer;
    }
    td.selected { background-color: #d0e8ff; }

    .points-display { text-align: center; font-size: 1.1rem; margin-top: 1rem; }

    .task-panel {
      background: white; border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      width: 100%; max-width: 700px; margin-top: 1rem; padding: 1rem;
    }

    .task-panel-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem;
    }
    .task-panel-header h3 { margin: 0; }
    
    .manage-tasks-btn {
      background-color: #4a90e2; color: white; border: none;
      border-radius: 5px; padding: 0.5rem 1rem; cursor: pointer;
      font-size: 0.9rem;
    }
    .manage-tasks-btn:hover { background-color: #357abd; }
    
    .task-list { list-style: none; padding: 0; }
    .task-list li { display: flex; align-items: center; margin: 0.4rem 0; }
    input[type="checkbox"] { margin-right: 10px; }

    /* ä»»å‹™ç®¡ç†å½ˆçª— */
    .modal {
      display: none; position: fixed; z-index: 1000;
      left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal.show { display: flex; justify-content: center; align-items: center; }
    .modal-content {
      background: white; border-radius: 10px;
      padding: 2rem; width: 90%; max-width: 500px;
      max-height: 80vh; overflow-y: auto;
    }
    .modal-header {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 1rem;
    }
    .modal-header h2 { margin: 0; }
    .close-btn {
      background: none; border: none; font-size: 1.5rem;
      cursor: pointer; color: #666;
    }
    .close-btn:hover { color: #000; }
    
    .manage-task-list { list-style: none; padding: 0; }
    .manage-task-list li {
      display: flex; align-items: center; gap: 0.5rem;
      margin: 0.5rem 0; padding: 0.5rem;
      border: 1px solid #ddd; border-radius: 5px;
    }
    .manage-task-list .task-text {
      flex: 1; padding: 0.4rem;
    }
    .manage-task-list input[type="text"] {
      flex: 1; padding: 0.4rem; border: 1px solid #ddd;
      border-radius: 3px; font-size: 1rem;
    }
    .edit-btn, .delete-btn, .save-btn, .cancel-btn {
      background-color: #4a90e2; color: white; border: none;
      border-radius: 3px; padding: 0.3rem 0.6rem;
      cursor: pointer; font-size: 0.85rem;
    }
    .delete-btn { background-color: #e74c3c; }
    .save-btn { background-color: #27ae60; }
    .cancel-btn { background-color: #95a5a6; }
    .edit-btn:hover { background-color: #357abd; }
    .delete-btn:hover { background-color: #c0392b; }
    .save-btn:hover { background-color: #229954; }
    .cancel-btn:hover { background-color: #7f8c8d; }
    
    .add-task-section {
      margin-top: 1rem; padding-top: 1rem;
      border-top: 1px solid #ddd;
    }
    .add-task-input {
      width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;
      border: 1px solid #ddd; border-radius: 5px; font-size: 1rem;
    }
    .add-task-btn {
      background-color: #27ae60; color: white; border: none;
      border-radius: 5px; padding: 0.5rem 1rem;
      cursor: pointer; width: 100%; font-size: 1rem;
    }
    .add-task-btn:hover { background-color: #229954; }

    @media (max-width: 600px) {
      th, td { font-size: 0.8rem; }
      td { height: 60px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>ğŸŒŸ æˆåŠŸæ—¥è¨˜ Success Journal ğŸŒŸ</h1>
    <p>è¨˜éŒ„æ¯å¤©å®Œæˆçš„ä»»å‹™ï¼Œç´¯ç©ä½ çš„æˆåŠŸé»æ•¸ï¼</p>
    <details class="instructions">
      <summary>ğŸ“– ä½¿ç”¨èªªæ˜</summary>
      <div>
        <p><strong>å¦‚ä½•ä½¿ç”¨ï¼š</strong></p>
        <ol>
          <li>é»æ“Šæ—¥æ›†ä¸Šçš„æ—¥æœŸé¸æ“‡è¦è¨˜éŒ„çš„æ—¥å­</li>
          <li>å‹¾é¸å®Œæˆçš„ä»»å‹™é …ç›®</li>
          <li>æŸ¥çœ‹ç•¶æ—¥å®Œæˆçš„é»æ•¸</li>
        </ol>
        <p><strong>å¦‚ä½•ç®¡ç†ä»»å‹™ï¼š</strong></p>
        <ol>
          <li>é»æ“Šä»»å‹™é¢æ¿å³ä¸Šè§’çš„ã€Œâš™ï¸ ç®¡ç†ä»»å‹™ã€æŒ‰éˆ•</li>
          <li><strong>æ–°å¢ä»»å‹™</strong>ï¼šåœ¨æœ€ä¸‹æ–¹è¼¸å…¥æ¡†è¼¸å…¥ä»»å‹™åç¨±ï¼Œé»æ“Šã€Œâ• æ–°å¢ä»»å‹™ã€</li>
          <li><strong>ç·¨è¼¯ä»»å‹™</strong>ï¼šé»æ“Šä»»å‹™æ—çš„ã€Œç·¨è¼¯ã€æŒ‰éˆ•ï¼Œä¿®æ”¹ä»»å‹™åç¨±å¾Œé»æ“Šã€Œä¿å­˜ã€</li>
          <li><strong>åˆªé™¤ä»»å‹™</strong>ï¼šé»æ“Šä»»å‹™æ—çš„ã€Œåˆªé™¤ã€æŒ‰éˆ•ï¼ˆæœƒç¢ºèªå¾Œåˆªé™¤ï¼‰</li>
          <li>ç®¡ç†å®Œæˆå¾Œé»æ“Šå³ä¸Šè§’ã€ŒÃ—ã€é—œé–‰å½ˆçª—</li>
        </ol>
      </div>
    </details>
  </header>

  <main>
    <div class="calendar">
      <div class="month-selector">
        <button id="prevMonth">â†</button>
        <span id="monthYear"></span>
        <button id="nextMonth">â†’</button>
      </div>
      <table id="calendarTable">
        <thead>
          <tr>
            <th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="task-panel">
      <div class="task-panel-header">
        <h3 id="selectedDateTitle">ğŸ“… è«‹å…ˆé¸æ“‡æ—¥æœŸ</h3>
        <button class="manage-tasks-btn" id="manageTasksBtn">âš™ï¸ ç®¡ç†ä»»å‹™</button>
      </div>
      <ul class="task-list" id="taskList"></ul>
      <div class="points-display" id="pointsDisplay"></div>
    </div>
  </main>

  <!-- ä»»å‹™ç®¡ç†å½ˆçª— -->
  <div class="modal" id="taskModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“ ç®¡ç†ä»»å‹™é …ç›®</h2>
        <button class="close-btn" id="closeModal">&times;</button>
      </div>
      <ul class="manage-task-list" id="manageTaskList"></ul>
      <div class="add-task-section">
        <input type="text" class="add-task-input" id="newTaskInput" placeholder="è¼¸å…¥æ–°ä»»å‹™åç¨±...">
        <button class="add-task-btn" id="addTaskBtn">â• æ–°å¢ä»»å‹™</button>
      </div>
    </div>
  </div>

  <script>
    const tbody = document.querySelector("#calendarTable tbody");
    const monthYear = document.getElementById("monthYear");
    const selectedDateTitle = document.getElementById("selectedDateTitle");
    const taskListEl = document.getElementById("taskList");
    const pointsDisplay = document.getElementById("pointsDisplay");
    const manageTasksBtn = document.getElementById("manageTasksBtn");
    const taskModal = document.getElementById("taskModal");
    const closeModal = document.getElementById("closeModal");
    const manageTaskList = document.getElementById("manageTaskList");
    const newTaskInput = document.getElementById("newTaskInput");
    const addTaskBtn = document.getElementById("addTaskBtn");

    let currentDate = new Date();
    let selectedDate = null;

    // ---- LocalStorage å®‰å…¨å°è£ ----
    const safeStorage = (() => {
      try {
        const test = "__test_key__";
        localStorage.setItem(test, "ok");
        localStorage.removeItem(test);
        return localStorage;
      } catch {
        console.warn("âš ï¸ æœ¬åœ°å„²å­˜ä¸å¯ç”¨ï¼Œä½¿ç”¨æš«å­˜æ¨¡å¼ã€‚");
        const memory = {};
        return {
          getItem: key => memory[key],
          setItem: (key, value) => (memory[key] = value),
          removeItem: key => delete memory[key]
        };
      }
    })();

    // ---- ä»»å‹™ç®¡ç†åŠŸèƒ½ ----
    function getTasks() {
      const defaultTasks = [
        "æ—©èµ·é‹å‹•", "è®€æ›¸30åˆ†é˜", "å¯«æ—¥è¨˜", "å¹«åŠ©ä»–äºº", "å­¸ç¿’æ–°æŠ€èƒ½",
        "å®Œæˆå·¥ä½œæˆ–å­¸æ¥­ä»»å‹™", "æ•´ç†ç’°å¢ƒ", "ç·´ç¿’å†¥æƒ³",
        "é¿å…æ»‘æ‰‹æ©Ÿæµªè²»æ™‚é–“", "ä¿æŒå¥½å¿ƒæƒ…"
      ];
      const saved = safeStorage.getItem("customTasks");
      return saved ? JSON.parse(saved) : defaultTasks;
    }

    function saveTasks(tasks) {
      safeStorage.setItem("customTasks", JSON.stringify(tasks));
    }

    function openTaskModal() {
      taskModal.classList.add("show");
      renderManageTaskList();
    }

    function closeTaskModal() {
      taskModal.classList.remove("show");
      if (selectedDate) renderTasks(); // é‡æ–°æ¸²æŸ“ä»»å‹™åˆ—è¡¨
    }

    function renderManageTaskList() {
      const tasks = getTasks();
      manageTaskList.innerHTML = "";
      
      tasks.forEach((task, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span class="task-text">${task}</span>
          <button class="edit-btn" data-index="${index}">ç·¨è¼¯</button>
          <button class="delete-btn" data-index="${index}">åˆªé™¤</button>
        `;
        manageTaskList.appendChild(li);
      });

      // ç¶å®šç·¨è¼¯æŒ‰éˆ•äº‹ä»¶
      document.querySelectorAll(".edit-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const index = parseInt(e.target.dataset.index);
          editTask(e.target.parentElement, index);
        });
      });

      // ç¶å®šåˆªé™¤æŒ‰éˆ•äº‹ä»¶
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          const index = parseInt(e.target.dataset.index);
          deleteTask(index);
        });
      });
    }

    function editTask(li, index) {
      const tasks = getTasks();
      const currentText = tasks[index];
      
      li.innerHTML = `
        <input type="text" class="edit-input" value="${currentText}">
        <button class="save-btn">ä¿å­˜</button>
        <button class="cancel-btn">å–æ¶ˆ</button>
      `;

      const input = li.querySelector(".edit-input");
      const saveBtn = li.querySelector(".save-btn");
      const cancelBtn = li.querySelector(".cancel-btn");

      input.focus();

      saveBtn.addEventListener("click", () => {
        const newText = input.value.trim();
        if (newText) {
          tasks[index] = newText;
          saveTasks(tasks);
          renderManageTaskList();
        }
      });

      cancelBtn.addEventListener("click", () => {
        renderManageTaskList();
      });

      input.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          saveBtn.click();
        }
      });
    }

    function deleteTask(index) {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ä»»å‹™å—ï¼Ÿ")) {
        const tasks = getTasks();
        tasks.splice(index, 1);
        saveTasks(tasks);
        renderManageTaskList();
      }
    }

    function addTask() {
      const newTask = newTaskInput.value.trim();
      if (newTask) {
        const tasks = getTasks();
        tasks.push(newTask);
        saveTasks(tasks);
        newTaskInput.value = "";
        renderManageTaskList();
      }
    }

    // äº‹ä»¶ç›£è½
    manageTasksBtn.addEventListener("click", openTaskModal);
    closeModal.addEventListener("click", closeTaskModal);
    taskModal.addEventListener("click", (e) => {
      if (e.target === taskModal) closeTaskModal();
    });
    addTaskBtn.addEventListener("click", addTask);
    newTaskInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") addTask();
    });

    // ---- æ—¥æ›†åŠŸèƒ½ ----
    function generateCalendar(year, month) {
      tbody.innerHTML = "";
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();

      monthYear.textContent = `${year} å¹´ ${month + 1} æœˆ`;
      let date = 1;

      for (let i = 0; i < 6; i++) {
        const row = document.createElement("tr");
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement("td");
          if (i === 0 && j < firstDay) {
            cell.textContent = "";
          } else if (date > daysInMonth) {
            cell.textContent = "";
          } else {
            cell.dataset.date = `${year}-${month + 1}-${date}`;
            cell.textContent = date;
            cell.addEventListener("click", () => selectDate(cell.dataset.date));
            date++;
          }
          row.appendChild(cell);
        }
        tbody.appendChild(row);
      }
    }

    function selectDate(dateStr) {
      selectedDate = dateStr;
      document.querySelectorAll("td").forEach(td => td.classList.remove("selected"));
      const target = [...document.querySelectorAll("td")].find(td => td.dataset.date === dateStr);
      if (target) target.classList.add("selected");
      selectedDateTitle.textContent = `ğŸ“… ${dateStr} çš„ä»»å‹™`;
      renderTasks();
    }

    function getAllRecords() {
      return JSON.parse(safeStorage.getItem("successJournal") || "{}");
    }

    function getRecordsForDate(date) {
      const all = getAllRecords();
      const tasks = getTasks();
      const record = all[date] || [];
      // ç¢ºä¿è¨˜éŒ„é•·åº¦èˆ‡ä»»å‹™æ•¸é‡ä¸€è‡´
      return [...record, ...new Array(Math.max(0, tasks.length - record.length)).fill(false)].slice(0, tasks.length);
    }

    function saveRecordsForDate(date, data) {
      const all = getAllRecords();
      all[date] = data;
      safeStorage.setItem("successJournal", JSON.stringify(all));
    }

    function renderTasks() {
      const tasks = getTasks();
      taskListEl.innerHTML = "";
      const data = getRecordsForDate(selectedDate);
      
      tasks.forEach((task, i) => {
        const li = document.createElement("li");
        const checked = data[i] ? "checked" : "";
        li.innerHTML = `<input type="checkbox" id="task${i}" ${checked}>
                        <label for="task${i}">${task}</label>`;
        li.querySelector("input").addEventListener("change", e => {
          data[i] = e.target.checked;
          saveRecordsForDate(selectedDate, data);
          updatePoints(data);
        });
        taskListEl.appendChild(li);
      });
      updatePoints(data);
    }

    function updatePoints(records) {
      const score = records.filter(v => v).length;
      pointsDisplay.textContent = `â­ ä»Šæ—¥é»æ•¸ï¼š${score} / ${getTasks().length}`;
    }

    document.getElementById("prevMonth").onclick = () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    };
    
    document.getElementById("nextMonth").onclick = () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
    };

    generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
  </script>
</body>
</html>